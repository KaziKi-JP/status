<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Status 管理パネル</title>

<style>
/* =============================
   Base
============================= */
body {
  font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: #f5f7fa;
  margin: 0;
  color: #333;
}

/* =============================
   Header
============================= */
header {
  position: fixed;
  top: 0;
  width: 100%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(10px);
  padding: 18px 28px 14px;
  border-bottom: 1px solid rgba(200, 200, 200, 0.4);
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 14px;
}

header h1 {
  margin: 0;
  font-size: 22px;
  font-weight: 600;
}

.admin-badge {
  background: rgba(255, 59, 48, 0.85);
  color: #fff;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  backdrop-filter: blur(4px);
}

main {
  max-width: 780px;
  margin: 110px auto;
  padding: 0 20px;
}

/* =============================
   Card (Glass UI)
============================= */
.card {
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  border: 1px solid rgba(220,220,220,0.6);
  padding: 22px 28px;
  margin-bottom: 24px;

  box-shadow:
    0 4px 12px rgba(0,0,0,0.06),
    0 2px 8px rgba(0,0,0,0.04);
  animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* =============================
   Form UI
============================= */
label {
  display: block;
  margin-top: 12px;
  font-weight: 600;
}

input[type="text"],
input[type="password"],
select {
  width: 100%;
  padding: 10px 12px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid rgba(140,140,140,0.4);
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(6px);
  font-size: 15px;
  transition: 0.25s;
}

input:hover, select:hover {
  border-color: #007aff;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 20px;
  background: #007aff;
  color: white;
  border: none;
  font-size: 16px;
  border-radius: 10px;
  font-weight: 600;
  transition: 0.25s;
}

button:hover {
  background: #0062d6;
}

/* =============================
   Service Item UI
============================= */
.service-item {
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(200,200,200,0.5);
  border-radius: 12px;
  padding: 16px;
  margin-top: 14px;

  box-shadow:
    0 3px 8px rgba(0,0,0,0.05),
    0 1px 4px rgba(0,0,0,0.04);
}

.remove-btn {
  background: #ff3b30;
  margin-top: 8px;
}

/* =============================
   Notify Banner
============================= */
#notify {
  position: fixed;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(10px);
  padding: 14px 22px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  font-weight: 600;
  font-size: 15px;
  color: #333;
  transition: all 0.4s ease;
  border: 1px solid rgba(200,200,200,0.5);
  z-index: 100;
}

#notify.show {
  top: 20px;
}

/* =============================
   Footer
============================= */
footer {
  margin-top: 60px;
  text-align: center;
  font-size: 12px;
  color: #999;
  padding-bottom: 30px;
}
</style>
</head>

<body>
<header>
  <h1>ステータス管理</h1>
  <span class="admin-badge">ADMIN PANEL</span>
</header>

<div id="notify"></div>

<main>

<!-- GitHub 設定 -->
<div class="card">
  <h3>GitHub 設定</h3>

  <label>GitHub Token（必須）</label>
  <input type="password" id="token" placeholder="GitHub Token を入力">

  <label>Repository</label>
  <input type="text" id="repo" value="KaziKi-JP/status">

  <label>status.json のパス</label>
  <input type="text" id="path" value="status.json">

  <button onclick="loadStatus()">現在のステータスを読み込む</button>
  
  <div id="loadResult"></div>
</div>


<!-- ステータス編集 -->
<div class="card">
  <h3>全体ステータス</h3>

  <label>全体ステータス</label>
  <select id="global_status">
    <option value="up">正常</option>
    <option value="nomal">不安定</option>
    <option value="down">異常</option>
    <option value="maint">メンテナンス</option>
  </select>

  <label>メッセージ</label>
  <input type="text" id="global_message">

</div>


<!-- サービス編集 -->
<div class="card">
  <h3>サービス一覧</h3>

  <div id="serviceList"></div>

  <button onclick="addService()">＋ サービス追加</button>
  <button onclick="saveStatus()">ステータスを保存する</button>

  <div id="saveResult"></div>
</div>

<footer>© 2025 KKserver</footer>

</main>


<script>
function notify(msg) {
  const bar = document.getElementById("notify");
  bar.textContent = msg;
  bar.classList.add("show");
  setTimeout(() => bar.classList.remove("show"), 2500);
}

function apiUrl(repo, path) {
  return `https://api.github.com/repos/${repo}/contents/${path}`;
}

/* ===========================
   ステータス読み込み
=========================== */
async function loadStatus() {
  const tokenVal = document.getElementById("token").value;
  const repoVal  = document.getElementById("repo").value;
  const pathVal  = document.getElementById("path").value;

  try {
    const res = await fetch(apiUrl(repoVal, pathVal), {
      headers: { Authorization: `Bearer ${tokenVal}` }
    });

    if (!res.ok) throw new Error("読み込み失敗");

    const data = await res.json();
    const content = JSON.parse(atob(data.content));

    document.getElementById("global_status").value = content.global.status;
    document.getElementById("global_message").value = content.global.label;

    // ★ services に正しくセット
    services = content.services;

    renderServices(services);
    notify("読み込み成功！");
  } catch (e) {
    notify("エラー: " + e.message);
  }
}

/* ===========================
   サービス描画
=========================== */
function renderServices(list) {
  const box = document.getElementById("serviceList");
  box.innerHTML = "";

  list.forEach((svc, i) => {
    const el = document.createElement("div");
    el.classList.add("service-item");

    el.innerHTML = `
      <label>サービス名</label>
      <input type="text" data-i="${i}" data-field="name" value="${svc.name}">

      <label>ステータス</label>
      <select data-i="${i}" data-field="status">
        <option value="up"    ${svc.status==="up"?"selected":""}>正常</option>
        <option value="nomal" ${svc.status==="nomal"?"selected":""}>不安定</option>
        <option value="down"  ${svc.status==="down"?"selected":""}>異常</option>
        <option value="maint" ${svc.status==="maint"?"selected":""}>メンテナンス</option>
      </select>

      <label>ラベル</label>
      <input type="text" data-i="${i}" data-field="label" value="${svc.label}">

      <button class="remove-btn" onclick="removeService(${i})">削除</button>
    `;

    box.appendChild(el);
  });
}

/* ===========================
   サービス追加
=========================== */
function addService() {
  services.push({
    name: "新しいサービス",
    status: "up",
    label: "稼働中"
  });
  renderServices(services);
}

/* ===========================
   サービス削除
=========================== */
function removeService(i) {
  services.splice(i, 1);
  renderServices(services);
}

/* ===========================
   保存
=========================== */
async function saveStatus() {
  const tokenVal = document.getElementById("token").value;
  const repoVal  = document.getElementById("repo").value;
  const pathVal  = document.getElementById("path").value;

  // UI → 配列再構築
  const inputs = document.querySelectorAll("[data-field]");
  const newList = [];

  inputs.forEach(i => {
    const index = Number(i.dataset.i);
    if (!newList[index]) newList[index] = {};
    newList[index][i.dataset.field] = i.value;
  });

  const body = {
    updated: new Date().toLocaleString("ja-JP", { hour12: false }),
    global: {
      status: document.getElementById("global_status").value,
      label: document.getElementById("global_message").value
    },
    services: newList
  };

  try {
    const getRes = await fetch(apiUrl(repoVal, pathVal), {
      headers: { Authorization: `Bearer ${tokenVal}` }
    });

    const getData = await getRes.json();

    const putRes = await fetch(apiUrl(repoVal, pathVal), {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${tokenVal}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update status",
        content: btoa(unescape(encodeURIComponent(JSON.stringify(body, null, 2)))),
        sha: getData.sha
      })
    });

    if (!putRes.ok) throw new Error("保存失敗");

    notify("保存しました！");
  } catch (e) {
    notify("エラー: " + e.message);
  }
}

let services = [];
</script>


</body>
</html>
