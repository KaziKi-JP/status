<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Status 管理画面</title>
<style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-top: 40px; }
    .service { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .row { margin-bottom: 5px; }
    button { padding: 6px 12px; }
</style>
</head>
<body>

<h1>ステータス管理画面</h1>

<h2>GitHub 設定</h2>
<div>
    <label>リポジトリ所有者（GitHub ユーザー名）：<br>
        <input id="owner" value="kaziki-jp" style="width:300px">
    </label><br><br>
    <label>リポジトリ名：<br>
        <input id="repo" value="status" style="width:300px">
    </label><br><br>
    <label>Token（repo 権限付き Classic Token）：<br>
        <input id="token" type="password" style="width:300px">
    </label>
</div>

<hr>

<h2>現在のステータスを読み込む</h2>
<button onclick="loadStatus()">読み込む</button>
<div id="loadMessage"></div>

<hr>

<h2>全体ステータス</h2>
<label>
    状態：
    <select id="global_status">
        <option value="up">up (稼働中)</option>
        <option value="down">down (ダウン)</option>
        <option value="nomal">nomal (不安定)</option>
        <option value="maint">maint (メンテ)</option>
    </select>
</label>
<br><br>
<label>
    ラベル：
    <input id="global_label" style="width:200px">
</label>

<hr>

<h2>サービス一覧</h2>
<div id="services"></div>
<button onclick="addService()">＋ サービス追加</button>

<hr>

<h2>保存</h2>
<button onclick="saveStatus()">status.json を更新</button>
<div id="saveMessage"></div>

<script>
// ----------------------------
// service block generator
// ----------------------------
function createServiceBlock(service, index) {
    return `
    <div class="service" id="service_${index}">
        <div class="row">
            <label>サービス名：<input value="${service.name}" class="s_name"></label>
        </div>
        <div class="row">
            <label>ステータス：
                <select class="s_status">
                    <option value="up" ${service.status === "up" ? "selected" : ""}>up</option>
                    <option value="down" ${service.status === "down" ? "selected" : ""}>down</option>
                    <option value="nomal" ${service.status === "nomal" ? "selected" : ""}>nomal</option>
                    <option value="maint" ${service.status === "maint" ? "selected" : ""}>maint</option>
                </select>
            </label>
        </div>
        <div class="row">
            <label>ラベル：<input value="${service.label}" class="s_label"></label>
        </div>
        <div class="row">
            <label>
                <input type="checkbox" class="s_special" ${service.special ? "checked" : ""}>
                special（任意）
            </label>
        </div>
        <button onclick="deleteService(${index})">削除</button>
    </div>`;
}

// ----------------------------
// Add service
// ----------------------------
function addService() {
    const servicesDiv = document.getElementById("services");
    const index = servicesDiv.children.length;

    const newService = {
        name: "新しいサービス",
        status: "up",
        label: "稼働中",
        special: false
    };

    servicesDiv.insertAdjacentHTML("beforeend", createServiceBlock(newService, index));
}

// ----------------------------
// Delete service
// ----------------------------
function deleteService(index) {
    document.getElementById("service_" + index).remove();
}

// ----------------------------
// Load current status.json
// ----------------------------
async function loadStatus() {
    const owner = document.getElementById("owner").value;
    const repo = document.getElementById("repo").value;
    const url = `https://raw.githubusercontent.com/${owner}/${repo}/main/status.json`;

    document.getElementById("loadMessage").innerText = "読み込み中…";

    try {
        const res = await fetch(url + "?t=" + Date.now());
        if (!res.ok) throw new Error("status.json が読み込めません");

        const content = await res.json();

        // Set global status
        document.getElementById("global_status").value = content.global.status;
        document.getElementById("global_label").value = content.global.label;

        // Set services
        const servicesDiv = document.getElementById("services");
        servicesDiv.innerHTML = "";
        content.services.forEach((srv, idx) => {
            servicesDiv.insertAdjacentHTML("beforeend", createServiceBlock(srv, idx));
        });

        document.getElementById("loadMessage").innerText = "読み込み成功！";

    } catch (e) {
        document.getElementById("loadMessage").innerText = "エラー: " + e.message;
    }
}

// ----------------------------
// Save updated status.json
// ----------------------------
async function saveStatus() {
    const owner = document.getElementById("owner").value;
    const repo = document.getElementById("repo").value;
    const token = document.getElementById("token").value;

    if (!token) {
        alert("Token を入力してください");
        return;
    }

    document.getElementById("saveMessage").innerText = "保存中…";

    // Build JSON data
    const servicesDiv = document.getElementById("services");
    const serviceBlocks = [...servicesDiv.children];

    const services = serviceBlocks.map(div => ({
        name: div.querySelector(".s_name").value,
        status: div.querySelector(".s_status").value,
        label: div.querySelector(".s_label").value,
        special: div.querySelector(".s_special").checked
    }));

    const data = {
        updated: new Date().toISOString().replace("T", " ").substring(0, 19),
        global: {
            status: document.getElementById("global_status").value,
            label: document.getElementById("global_label").value
        },
        services: services
    };

    // ----------------------------
    // Get file SHA
    // ----------------------------
    const shaRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/status.json`,
        { headers: { Authorization: `token ${token}` } }
    );

    if (!shaRes.ok) {
        document.getElementById("saveMessage").innerText = "エラー: SHA取得失敗";
        return;
    }

    const shaData = await shaRes.json();
    const sha = shaData.sha;

    // ----------------------------
    // Upload new status.json
    // ----------------------------
    const updateRes = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/status.json`,
        {
            method: "PUT",
            headers: {
                Authorization: `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Update status.json",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: sha
            })
        }
    );

    if (updateRes.ok) {
        document.getElementById("saveMessage").innerText = "保存成功！";
    } else {
        document.getElementById("saveMessage").innerText = "保存エラー";
    }
}
</script>

</body>
</html>
